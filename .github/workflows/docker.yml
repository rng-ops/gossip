name: Docker Build & Push

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/terraingossip

jobs:
  # ===========================================================================
  # Build and test Docker images
  # ===========================================================================
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: builder
          push: false
          load: true
          tags: terraingossip/builder:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Rust tests in Docker
        run: |
          docker run --rm terraingossip/builder:test cargo test --workspace --all-targets

      - name: Build all daemon images
        run: |
          docker compose -f docker-compose.test.yml build gossipd routerd

  # ===========================================================================
  # Build and push images on main/tags
  # ===========================================================================
  push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        image:
          - name: gossipd
            target: gossipd
          - name: routerd
            target: routerd
          - name: prober
            target: prober
          - name: infernode
            target: infernode
          - name: all
            target: all
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.image.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          target: ${{ matrix.image.target }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # ===========================================================================
  # Integration test with docker-compose
  # ===========================================================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build all images
        run: docker compose build

      - name: Start services
        run: |
          docker compose up -d gossipd
          sleep 5
          docker compose up -d routerd prober infernode
          sleep 5

      - name: Check service health
        run: |
          echo "Checking gossipd..."
          docker compose ps gossipd
          docker compose logs gossipd
          
          echo "Checking routerd..."
          docker compose ps routerd
          docker compose logs routerd
          
          echo "Checking prober..."
          docker compose ps prober
          docker compose logs prober
          
          echo "Checking infernode..."
          docker compose ps infernode
          docker compose logs infernode

      - name: Run integration tests
        run: |
          # Basic connectivity tests
          docker compose exec -T gossipd gossipd --help
          docker compose exec -T routerd routerd --help
          docker compose exec -T prober prober --help
          docker compose exec -T infernode infernode --help
          
          echo "All services responding!"

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose logs --tail=100

      - name: Stop services
        if: always()
        run: docker compose down -v
